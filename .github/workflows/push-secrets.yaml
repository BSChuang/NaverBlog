name: Push Kubernetes Secrets

on:
  workflow_dispatch:

jobs:
  push-secrets:
    name: Create Kubernetes Secrets on EC2
    runs-on: ubuntu-latest

    steps:
      - name: SSH into EC2 and Create Secrets
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,OPENAI_API_KEY,DISCORD_BOT_TOKEN,DISCORD_CHANNEL_ID
          script: |
            set -e

            echo "Creating quiz-secrets..."
            sudo kubectl --kubeconfig=/etc/rancher/k3s/k3s.yaml delete secret quiz-secrets --ignore-not-found
            sudo kubectl --kubeconfig=/etc/rancher/k3s/k3s.yaml create secret generic quiz-secrets \
              --from-literal=OPENAI_API_KEY="$OPENAI_API_KEY" \
              --from-literal=DISCORD_BOT_TOKEN="$DISCORD_BOT_TOKEN" \
              --from-literal=DISCORD_CHANNEL_ID="$DISCORD_CHANNEL_ID"

            echo "Exporting AWS credentials..."
            export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
            export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY

            echo "Authenticating Docker to ECR..."
            aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
            aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"

            aws ecr get-login-password --region us-east-1 | \
              docker login --username AWS --password-stdin 453004141968.dkr.ecr.us-east-1.amazonaws.com

            echo "Creating image pull secret 'regcred'..."
            sudo kubectl --kubeconfig=/etc/rancher/k3s/k3s.yaml delete secret regcred --ignore-not-found
            sudo kubectl --kubeconfig=/etc/rancher/k3s/k3s.yaml create secret generic regcred \
              --from-file=.dockerconfigjson=/home/ubuntu/.docker/config.json \
              --type=kubernetes.io/dockerconfigjson

            echo "All secrets created successfully."
