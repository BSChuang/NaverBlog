name: Push Kubernetes Secrets

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Are you sure you want to overwrite Kubernetes secrets?'
        required: true
        default: 'no'

jobs:
  push-secrets:
    name: Create Kubernetes Secrets on EC2
    if: github.event.inputs.confirm == 'yes'
    runs-on: ubuntu-latest

    steps:
      - name: SSH into EC2 and Create Secrets
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.AWS_ACCESS_KEY_ID }}
          username: ubuntu
          key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          script: |
            kubectl delete secret quiz-secrets --ignore-not-found
            kubectl create secret generic quiz-secrets \
              --from-literal=OPENAI_API_KEY='${{ secrets.OPENAI_API_KEY }}' \
              --from-literal=DISCORD_BOT_TOKEN='${{ secrets.DISCORD_BOT_TOKEN }}' \
              --from-literal=DISCORD_CHANNEL_ID='${{ secrets.DISCORD_CHANNEL_ID }}'